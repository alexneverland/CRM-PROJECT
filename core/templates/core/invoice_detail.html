{% extends 'core/base.html' %}
{% load static %}

{% block title %}Τιμολόγιο: {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-file-earmark-text-fill me-2"></i>Τιμολόγιο: {{ invoice.invoice_number }}</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            
        {# Εμφάνιση κουμπιών μόνο αν το τιμολόγιο δεν είναι Ακυρωμένο ή Πιστωμένο #}
        {% if invoice.status != invoice.STATUS_CANCELLED and invoice.status != invoice.STATUS_CREDITED %}
            <a href="{% url 'invoice_edit' invoice.pk %}" class="btn btn-sm btn-primary me-2"><i class="bi bi-pencil-square"></i> Επεξεργασία</a>

            {% if invoice.status == invoice.STATUS_ISSUED or invoice.status == invoice.STATUS_PAID %}
                <a href="{% url 'create_credit_note' invoice.pk %}" class="btn btn-sm btn-warning me-2">
                    <i class="bi bi-journal-minus"></i> Έκδοση Πιστωτικού
                </a>
            {% endif %}
            
            {% if invoice.status == invoice.STATUS_ISSUED and invoice.issue_date == today %}
            <form action="{% url 'invoice_cancel' invoice.pk %}" method="post" class="d-inline delete-form" data-item-name="{{ invoice.invoice_number }}" data-item-type="το τιμολόγιο">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger me-2" title="Ακύρωση Αυθημερόν">
                    <i class="bi bi-x-circle"></i> Ακύρωση
                </button>
            </form>
            {% endif %}
        {% endif %}

        {# --- ΔΙΟΡΘΩΜΕΝΟ "ΕΞΥΠΝΟ" ΚΟΥΜΠΙ PDF --- #}
        <a href="{% if invoice.status == invoice.STATUS_CANCELLED %}{% url 'invoice_cancellation_pdf' invoice.pk %}{% else %}{% url 'invoice_pdf' invoice.pk %}{% endif %}" class="btn btn-sm btn-info" target="_blank">
            <i class="bi bi-printer"></i>
            {% if invoice.status == invoice.STATUS_CANCELLED %}
                Εκτύπωση Ακυρωτικού
            {% else %}
                PDF
            {% endif %}
        </a>

        <a href="{% url 'invoice_list' %}" class="btn btn-sm btn-outline-secondary ms-2">
            <i class="bi bi-arrow-left-circle"></i> Επιστροφή στη Λίστα
        </a>
    </div>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="card mb-4">
                <div class="card-header">Στοιχεία Τιμολογίου</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4"><strong>Πελάτης:</strong></div>
                        <div class="col-sm-8"><a href="{% url 'customer_financial_detail' invoice.customer.pk %}">{{ invoice.customer }}</a></div>
                    </div>
                    <hr class="my-2">
                    
                    {# Εμφάνιση σχετικών παραστατικών #}
                    {% if invoice.order %}
                    <div class="row">
                        <div class="col-sm-4"><strong>Σχετική Παραγγελία:</strong></div>
                        <div class="col-sm-8"><a href="{% url 'order_detail' invoice.order.pk %}">{{ invoice.order.order_number }}</a></div>
                    </div>
                    {% endif %}
                    {% if invoice.delivery_note %}
                    <div class="row">
                        <div class="col-sm-4"><strong>Σχετικό Δ.Α.:</strong></div>
                        <div class="col-sm-8"><a href="{% url 'delivery_note_detail' invoice.delivery_note.pk %}">{{ invoice.delivery_note.delivery_note_number }}</a></div>
                    </div>
                    {% endif %}
                    <hr class="my-2">

                    <div class="row">
                        <div class="col-sm-4"><strong>Ημερομηνία Έκδοσης:</strong></div>
                        <div class="col-sm-8">{{ invoice.issue_date|date:"d/m/Y" }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>Ημερομηνία Λήξης:</strong></div>
                        <div class="col-sm-8">{{ invoice.due_date|date:"d/m/Y"|default:"-" }}</div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-sm-4"><strong>Κατάσταση:</strong></div>
                        <div class="col-sm-8">
                            <span class="badge 
                                {% if invoice.status == invoice.STATUS_PAID %}bg-success
                                {% elif invoice.status == invoice.STATUS_ISSUED %}bg-primary
                                {% elif invoice.status == invoice.STATUS_CANCELLED %}bg-danger
                                {% elif invoice.status == invoice.STATUS_CREDITED %}bg-secondary
                                {% else %}bg-dark{% endif %}">
                                {{ invoice.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card mb-4">
                <div class="card-header">Οικονομικά Σύνολα</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between"><span>Υποσύνολο:</span> <strong>{{ invoice.subtotal|floatformat:2 }} €</strong></div>
                    <div class="d-flex justify-content-between"><span>Ποσό ΦΠΑ:</span> <strong>{{ invoice.vat_amount|floatformat:2 }} €</strong></div>
                    <hr>
                    <div class="d-flex justify-content-between h4"><span>Τελικό Ποσό:</span> <strong class="text-primary">{{ invoice.total_amount|floatformat:2 }} €</strong></div>
                    <div class="d-flex justify-content-between text-success"><span>Εξοφλημένο:</span> <strong>{{ invoice.paid_amount|floatformat:2 }} €</strong></div>
                    <div class="d-flex justify-content-between text-danger"><span>Υπόλοιπο:</span> <strong>{{ invoice.outstanding_amount|floatformat:2 }} €</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-2">
        <div class="card-header">
            <h5 class="mb-0">Είδη Τιμολογίου</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="ps-3">Περιγραφή</th>
                            <th scope="col" class="text-center">Ποσότητα</th>
                            <th scope="col" class="text-end">Τιμή Μον.</th>
                            <th scope="col" class="text-center">Έκπτ. %</th>
                            <th scope="col" class="text-end">Αξία (προ ΦΠΑ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in invoice.items.all %}
                            <tr>
                                <td class="ps-3">{{ item.description }}</td>
                                <td class="text-center">{{ item.quantity|floatformat:2 }}</td>
                                <td class="text-end">{{ item.unit_price|floatformat:2 }} €</td>
                                <td class="text-center">{% if not item.is_gift and item.discount_percentage > 0 %}{{ item.discount_percentage|floatformat:0 }}%{% else %}-{% endif %}</td>
                                <td class="text-end fw-bold">{{ item.total_price|floatformat:2 }} €</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content %}