{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .pos-item-row td { vertical-align: middle; }
    .select2-container { width: 100% !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4"><i class="bi bi-cart-check-fill me-2"></i>{{ title }}</h1>

    <form method="post" id="pos-form" novalidate>
        {% csrf_token %}
        
        {# --- ΝΕΑ ΠΡΟΣΘΗΚΗ: ΠΕΔΙΟ ΠΕΛΑΤΗ --- #}
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="{{ form.customer_search.id_for_label }}" class="form-label">{{ form.customer_search.label }}</label>
                        {{ form.customer_search }}
                        {{ form.customer }}
                    </div>
                </div>
            </div>
        </div>
        
        {{ formset.management_form }}
        
        <div class="card">
            <div class="card-header">
                Είδη Απόδειξης
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 35%;">Προϊόν</th>
                            <th class="text-center" style="width: 10%;">Ποσότητα</th>
                            <th class="text-end" style="width: 12%;">Τιμή Μον. (Καθαρή)</th>
                            <th class="text-center" style="width: 8%;">Έκπτ. %</th>
                            <th class="text-end" style="width: 12%;">Καθαρή Αξία</th>
                            <th class="text-end" style="width: 10%;">ΦΠΑ</th>
                            <th class="text-end" style="width: 13%;">Τελική Αξία</th>
                            <th style="width: 5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="pos-items-container">
                        {% for item_form in formset %}
                        <tr class="pos-item-row" data-vat-rate="{{ item_form.instance.product.vat_percentage|default:0 }}">
                            {{ item_form.product }}
                            <td>{{ item_form.product_search }}</td>
                            <td>{{ item_form.quantity }}</td>
                            <td class="text-end">{{ item_form.unit_price }}</td>
                            <td>{{ item_form.discount_percentage }}</td>
                            <td class="line-subtotal text-end fw-bold">0.00 €</td>
                            <td class="line-vat text-end text-muted">0.00 €</td>
                            <td class="line-total text-end fw-bolder">0.00 €</td>
                            <td class="text-center">{% if item_form.can_delete %}{{ item_form.DELETE }}{% endif %}</td>
                        </tr>
                        {% if item_form.errors %}
                        <tr class="formset-error-row">
                            <td colspan="8">
                                <div class="alert alert-danger p-2 small mb-1">
                                    <ul class="list-unstyled mb-0">
                                    {% for field in item_form %}
                                        {% for error in field.errors %}
                                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                <button type="button" id="add-item-pos" class="btn btn-outline-secondary btn-sm">➕ Προσθήκη Γραμμής</button>
            </div>
            <div class="card-footer">
                <div class="row justify-content-end text-end">
                    <div class="col-md-5">
                        <div class="d-flex justify-content-between">
                            <h6 class="text-muted">Καθαρή Αξία:</h6>
                            <h6 id="subtotal-display-pos">0.00 €</h6>
                        </div>
                        <div class="d-flex justify-content-between">
                            <h6 class="text-muted">Σύνολο ΦΠΑ:</h6>
                            <h6 id="vat-display-pos">0.00 €</h6>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between">
                            <h4 class="fw-bold">Γενικό Σύνολο:</h4>
                            <h4 class="fw-bold" id="grand-total">0.00 €</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-success btn-lg mt-3 w-100">Ολοκλήρωση & Έκδοση Απόδειξης</button>
    </form>
</div>

<table class="d-none">
    <tbody id="empty-form-template-pos">
        <tr class="pos-item-row" data-vat-rate="0">
            {{ formset.empty_form.product }}
            <td>{{ formset.empty_form.product_search }}</td>
            <td>{{ formset.empty_form.quantity }}</td>
            <td class="text-end">{{ formset.empty_form.unit_price }}</td>
            <td>{{ formset.empty_form.discount_percentage }}</td>
            <td class="line-subtotal text-end fw-bold">0.00 €</td>
            <td class="line-vat text-end text-muted">0.00 €</td>
            <td class="line-total text-end fw-bolder">0.00 €</td>
            <td class="text-center">{% if formset.empty_form.can_delete %}{{ formset.empty_form.DELETE }}{% endif %}</td>
        </tr>
    </tbody>
</table>

{% endblock %}


{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Η λογική για τους υπολογισμούς παραμένει ως έχει...
    function calculateTotals() {
        let grandTotal = 0; let grandSubtotal = 0; let grandVat = 0;
        $('.pos-item-row').each(function() {
            const row = $(this);
            if (row.find('input[name$="-DELETE"]').is(':checked')) {
                row.find('.line-subtotal, .line-vat, .line-total').text('0.00 €'); return;
            }
            const quantity = parseFloat(row.find('input[name$="-quantity"]').val()) || 0;
            const unitPriceNet = parseFloat(row.find('input[name$="-unit_price"]').val()) || 0;
            const discount = parseFloat(row.find('input[name$="-discount_percentage"]').val()) || 0;
            const vatRate = parseFloat(row.attr('data-vat-rate')) || 0;
            const unitPriceAfterDiscount = unitPriceNet * (1 - (discount / 100));
            const lineSubtotal = quantity * unitPriceAfterDiscount;
            const lineVat = lineSubtotal * (vatRate / 100);
            const lineTotal = lineSubtotal + lineVat;
            grandSubtotal += lineSubtotal; grandVat += lineVat;
            row.find('.line-subtotal').text(lineSubtotal.toFixed(2) + ' €');
            row.find('.line-vat').text(lineVat.toFixed(2) + ' €');
            row.find('.line-total').text(lineTotal.toFixed(2) + ' €');
        });
        grandTotal = grandSubtotal + grandVat;
        $('#subtotal-display-pos').text(grandSubtotal.toFixed(2) + ' €');
        $('#vat-display-pos').text(grandVat.toFixed(2) + ' €');
        $('#grand-total').text(grandTotal.toFixed(2) + ' €');
    }

    function initializePosRow(rowElement) {
        const productSearch = $(rowElement).find('input[name$="-product_search"]');
        const hiddenProductInput = $(rowElement).find('input[name$="-product"]');
        const unitPriceInput = $(rowElement).find('input[name$="-unit_price"]');
        productSearch.select2({
            placeholder: 'Αναζήτηση προϊόντος...',
            ajax: { url: "{% url 'search_products_ajax' %}", dataType: 'json', delay: 250, data: p => ({ q: p.term }), processResults: d => ({ results: d.results }) }
        }).on('select2:select', function(e) {
            const data = e.params.data;
            hiddenProductInput.val(data.id);
            unitPriceInput.val(parseFloat(data.price).toFixed(2));
            $(rowElement).attr('data-vat-rate', data.vat);
            var option = new Option(data.text, data.id, true, true);
            $(this).empty().append(option).trigger('change');
            calculateTotals();
        });
        $(rowElement).on('change keyup', 'input[name$="-quantity"], input[name$="-discount_percentage"]', calculateTotals);
        $(rowElement).on('change', 'input[name$="-DELETE"]', calculateTotals);
    }
    const container = $('#pos-items-container');
    $('#add-item-pos').on('click', function() {
        const totalFormsInput = $('#id_items-TOTAL_FORMS');
        let formIdx = parseInt(totalFormsInput.val());
        const template = $('#empty-form-template-pos').html().replace(/__prefix__/g, formIdx);
        const newRow = $(template);
        container.append(newRow);
        initializePosRow(newRow);
        totalFormsInput.val(formIdx + 1);
    });
    container.find('.pos-item-row').each(function() { initializePosRow(this); });
    
    // --- ΝΕΑ ΛΟΓΙΚΗ ΓΙΑ ΤΟ SELECT2 ΤΟΥ ΠΕΛΑΤΗ ---
    $('#id_customer_search').select2({
        placeholder: 'Πελάτης Λιανικής (Default)',
        allowClear: true,
        width: '100%',
        ajax: {
            url: "{% url 'search_customers_ajax' %}",
            dataType: 'json',
            delay: 250,
            data: params => ({ q: params.term }),
            processResults: data => ({ results: data.results })
        }
    }).on('select2:select', function(e) {
        var data = e.params.data;
        $('#id_customer').val(data.id);
        var option = new Option(data.text, data.id, true, true);
        $(this).empty().append(option).trigger('change');
    }).on('select2:unselect', function(e){
        $('#id_customer').val('');
    });

    calculateTotals();
});
</script>
{% endblock %}