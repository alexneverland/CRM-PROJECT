{% extends 'core/base.html' %}
{% load static %}

{% block title %}ÎšÎ±ÏÏ„Î­Î»Î±: {{ customer.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-person-lines-fill me-2"></i>ÎšÎ±ÏÏ„Î­Î»Î± Î ÎµÎ»Î¬Ï„Î·: {{ customer.get_full_name }}</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
             <a href="{% url 'customer_payment_create' customer.pk %}" class="btn btn-sm btn-outline-success me-2">
                <i class="bi bi-plus-circle-dotted"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î»Î·ÏÏ‰Î¼Î®Ï‚
            </a>
            <a href="{% url 'customer_financial_detail' customer.pk %}" class="btn btn-sm btn-outline-info me-2">
                <i class="bi bi-wallet2"></i> ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ® ÎšÎ±ÏÏ„Î­Î»Î±
            </a>
            <a href="{% url 'customer_edit' customer.pk %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-pencil-square"></i> Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î ÎµÎ»Î¬Ï„Î·
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">Î’Î±ÏƒÎ¹ÎºÎ¬ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± & Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î§ÏÎ­Ï‰ÏƒÎ·Ï‚</div>
                <div class="card-body">
                    <p><strong>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚:</strong> {{ customer.code }}</p>
                    <p><strong>Î•Ï„Î±Î¹ÏÎµÎ¯Î±:</strong> {{ customer.company_name|default:"-" }}</p>
                    <p><strong>Email:</strong> {{ customer.email|default:"-" }}</p>
                    <p><strong>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿:</strong> {{ customer.phone|default:"-" }}</p>
                    <p><strong>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:</strong> {{ customer.address|default:"-" }}, {{ customer.postal_code|default:"" }} {{ customer.city|default:"" }}</p>
                    <p><strong>Î‘.Î¦.Îœ.:</strong> {{ customer.vat_number|default:"-" }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ & Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚</div>
                <div class="card-body">
                     <p><strong>ÎšÏÏÎ¹Î± Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:</strong> {{ customer.address|default:"-" }}</p>
                     <p><strong>Î¥Ï€ÎµÏÎ¸Ï…Î½Î¿Ï‚ Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚:</strong> {{ customer.contact_person_name|default:"-" }}</p>
                     <p><strong>Î¤Î·Î». Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚:</strong> {{ customer.contact_person_phone|default:"-" }}</p>
                     <p><strong>Email Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚:</strong> {{ customer.contact_person_email|default:"-" }}</p>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-paperclip me-2"></i>Î•Ï€Î¹ÏƒÏ…Î½Î±Ï€Ï„ÏŒÎ¼ÎµÎ½Î± Î‘ÏÏ‡ÎµÎ¯Î± ({{ attachments.count }})</div>
                        <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                            {% if attachments %}
                                <ul class="list-group list-group-flush">
                                    {% for att in attachments %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <a href="{{ att.file.url }}" target="_blank">{{ att }}</a>
                                                <small class="d-block text-muted">{{ att.description|default:'' }} (Î±Ï€ÏŒ {{ att.uploaded_by.username }} ÏƒÏ„Î¹Ï‚ {{ att.uploaded_at|date:"d/m/Y" }})</small>
                                            </div>
                                            {# Î˜Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î® Î±ÏÎ³ÏŒÏ„ÎµÏÎ± Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚ #}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted text-center mb-0">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏ€Î¹ÏƒÏ…Î½Î±Ï€Ï„ÏŒÎ¼ÎµÎ½Î± Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï€ÎµÎ»Î¬Ï„Î·.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-upload me-2"></i>Î‘Î½Î­Î²Î±ÏƒÎ¼Î± ÎÎ­Î¿Ï… Î‘ÏÏ‡ÎµÎ¯Î¿Ï…</div>
                        <div class="card-body">
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                {{ attachment_form.as_p }}
                                <button type="submit" name="upload_file" class="btn btn-primary btn-sm mt-2 w-100">Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎšÎ¹Î½Î®ÏƒÎµÏ‰Î½</h4>
                <form method="get" action="{% url 'customer_detail' customer.pk %}" class="d-flex">
                    <input class="form-control form-control-sm me-2" type="search" name="q" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÎµ Î‘Ï. Î Î±Ï/Î¤Î¹Î¼/Î”Î‘..." value="{{ query|default:'' }}" aria-label="Search">
                    <button class="btn btn-outline-secondary btn-sm" type="submit">ğŸ”</button>
                </form>
            </div>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-tab-pane" type="button" role="tab" aria-controls="orders-tab-pane" aria-selected="true">
                        <i class="bi bi-receipt-cutoff"></i> Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ ({{ customer_orders.count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices-tab-pane" type="button" role="tab" aria-controls="invoices-tab-pane" aria-selected="false">
                        <i class="bi bi-file-earmark-text"></i> Î¤Î¹Î¼Î¿Î»ÏŒÎ³Î¹Î± ({{ customer_invoices.count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="delivery-notes-tab" data-bs-toggle="tab" data-bs-target="#delivery-notes-tab-pane" type="button" role="tab" aria-controls="delivery-notes-tab-pane" aria-selected="false">
                        <i class="bi bi-truck"></i> Î”ÎµÎ»Ï„Î¯Î± Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ ({{ customer_delivery_notes.count }})
                    </button>
                </li>
                {% if branches %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="branches-tab" data-bs-toggle="tab" data-bs-target="#branches-tab-pane" type="button" role="tab" aria-controls="branches-tab-pane" aria-selected="false">
                        <i class="bi bi-diagram-3"></i> Î¥Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± ({{ branches.count }})
                    </button>
                </li>
                {% endif %}
            </ul>
    
            <div class="tab-content" id="myTabContent">
                {# --- ÎšÎ‘Î¡Î¤Î•Î›Î‘ Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î©Î (Î”Î™ÎŸÎ¡Î˜Î©ÎœÎ•ÎÎ—) --- #}
                <div class="tab-pane fade show active" id="orders-tab-pane" role="tabpanel" aria-labelledby="orders-tab" tabindex="0">
                    <div class="table-responsive mt-3">
                        <div class="text-end mb-2">
                            <a href="{% url 'order_list' %}?customer_filter={{ customer.pk }}" class="btn btn-link btn-sm">Î ÏÎ¿Î²Î¿Î»Î® ÏŒÎ»Ï‰Î½ & Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ Î¦Î¯Î»Ï„ÏÎ± &raquo;</a>
                        </div>
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Î‘Ï. Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</th><th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th class="text-end">Î Î¿ÏƒÏŒ</th><th class="text-center">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in customer_orders %}
                                    <tr>
                                        <td><a href="{% url 'order_detail' order.pk %}">{{ order.order_number }}</a></td>
                                        <td>{{ order.order_date|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if order.status == order.STATUS_COMPLETED %}bg-success{% elif order.status == order.STATUS_PENDING %}bg-warning text-dark{% elif order.status == order.STATUS_PROCESSING %}bg-primary{% elif order.status == order.STATUS_CANCELLED %}bg-danger{% else %}bg-secondary{% endif %}">{{ order.get_status_display }}</span>
                                        </td>
                                        <td class="text-end">{{ order.total_amount|floatformat:2 }} â‚¬</td>
                                        <td class="text-center"><a href="{% url 'order_detail' order.pk %}" class="btn btn-sm btn-outline-info" title="Î ÏÎ¿Î²Î¿Î»Î®"><i class="bi bi-eye"></i></a></td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="5" class="text-center p-4">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚.</td></tr>
                                {% endfor %}
                                {% if branches %}
                                <div class="tab-pane fade" id="branches-tab-pane" role="tabpanel" aria-labelledby="branches-tab" tabindex="0">
                                    <div class="list-group mt-3">
                                        {% for branch in branches %}
                                            <a href="{% url 'customer_detail' branch.pk %}" class="list-group-item list-group-item-action">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h5 class="mb-1">{{ branch.company_name|default:branch.get_full_name }}</h5>
                                                    <small>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚: {{ branch.code }}</small>
                                                </div>
                                                <p class="mb-1">{{ branch.address|default:'-' }}, {{ branch.city|default:'' }}</p>
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
    
                {# --- ÎšÎ‘Î¡Î¤Î•Î›Î‘ Î¤Î™ÎœÎŸÎ›ÎŸÎ“Î™Î©Î (Î”Î™ÎŸÎ¡Î˜Î©ÎœÎ•ÎÎ—) --- #}
                <div class="tab-pane fade" id="invoices-tab-pane" role="tabpanel" aria-labelledby="invoices-tab" tabindex="0">
                    <div class="table-responsive mt-3">
                         <div class="text-end mb-2">
                            <a href="{% url 'invoice_list' %}?customer_filter={{ customer.pk }}" class="btn btn-link btn-sm">Î ÏÎ¿Î²Î¿Î»Î® ÏŒÎ»Ï‰Î½ & Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ Î¦Î¯Î»Ï„ÏÎ± &raquo;</a>
                        </div>
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Î‘Ï. Î¤Î¹Î¼Î¿Î»Î¿Î³Î¯Î¿Ï…</th><th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th class="text-end">Î Î¿ÏƒÏŒ</th><th class="text-center">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
                                </tr>
                            </thead>
                            <tbody>
                                 {% for invoice in customer_invoices %}
                                    <tr>
                                        <td><a href="{% url 'invoice_detail' invoice.pk %}">{{ invoice.invoice_number }}</a></td>
                                        <td>{{ invoice.issue_date|date:"d/m/Y" }}</td>
                                        <td><span class="badge {% if invoice.status == invoice.STATUS_PAID %}bg-success{% elif invoice.status == invoice.STATUS_ISSUED %}bg-primary{% elif invoice.status == invoice.STATUS_CANCELLED %}bg-danger{% else %}bg-secondary{% endif %}">{{ invoice.get_status_display }}</span></td>
                                        <td class="text-end">{{ invoice.total_amount|floatformat:2 }} â‚¬</td>
                                        <td class="text-center"><a href="{% url 'invoice_detail' invoice.pk %}" class="btn btn-sm btn-outline-info" title="Î ÏÎ¿Î²Î¿Î»Î®"><i class="bi bi-eye"></i></a></td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="5" class="text-center p-4">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï„Î¹Î¼Î¿Î»ÏŒÎ³Î¹Î±.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
    
                {# --- ÎšÎ‘Î¡Î¤Î•Î›Î‘ Î”Î•Î›Î¤Î™Î©Î Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î—Î£ (Î”Î™ÎŸÎ¡Î˜Î©ÎœÎ•ÎÎ—) --- #}
                <div class="tab-pane fade" id="delivery-notes-tab-pane" role="tabpanel" aria-labelledby="delivery-notes-tab" tabindex="0">
                    <div class="table-responsive mt-3">
                        <div class="text-end mb-2">
                            <a href="{% url 'delivery_note_list' %}?customer_filter={{ customer.pk }}" class="btn btn-link btn-sm">Î ÏÎ¿Î²Î¿Î»Î® ÏŒÎ»Ï‰Î½ & Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ Î¦Î¯Î»Ï„ÏÎ± &raquo;</a>
                        </div>
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Î‘Ï. Î”.Î‘.</th><th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th class="text-center">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
                                </tr>
                            </thead>
                            <tbody>
                                 {% for note in customer_delivery_notes %}
                                    <tr>
                                        <td><a href="{% url 'delivery_note_detail' note.pk %}">{{ note.delivery_note_number }}</a></td>
                                        <td>{{ note.issue_date|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if note.status == 'DELIVERED' %}bg-success{% elif note.status == 'SHIPPED' %}bg-primary{% elif note.status == 'PREPARING' %}bg-warning text-dark{% elif note.status == 'CANCELLED' %}bg-danger{% else %}bg-secondary{% endif %}">{{ note.get_status_display }}</span>
                                        </td>
                                        <td class="text-center"><a href="{% url 'delivery_note_detail' note.pk %}" class="btn btn-sm btn-outline-info" title="Î ÏÎ¿Î²Î¿Î»Î®"><i class="bi bi-eye"></i></a></td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="4" class="text-center p-4">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î”ÎµÎ»Ï„Î¯Î± Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}